<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>preview_sync.py - Synchronize between text and web views of a document &mdash; Project Name version 0.0 documentation</title>
    
    <link rel="stylesheet" href="_static/CodeChat.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     'version 0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Project Name version 0.0 documentation" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="index.html">Project Name version 0.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
          <div class="body">
            
  <div class="section" id="preview-sync-py-synchronize-between-text-and-web-views-of-a-document">
<h1>preview_sync.py - Synchronize between text and web views of a document<a class="headerlink" href="#preview-sync-py-synchronize-between-text-and-web-views-of-a-document" title="Permalink to this headline">¶</a></h1>
<p>With this module, cursor movement and mouse clicks in either view scroll to
and highlight the corresponding text in the other view. In addition, the text
is vertically synchronized: the y coordinate at which the last cursor movement
or mouse click occurred will show the same text in both views.</p>
<div class="section" id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Permalink to this headline">¶</a></h2>
<div class="section" id="third-party">
<h3>Third-party<a class="headerlink" href="#third-party" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python3"><div class="highlight"><pre>
<span class="kn">from</span> <span class="nn">PyQt4.QtCore</span> <span class="k">import</span> <span class="n">pyqtSignal</span><span class="p">,</span> <span class="n">QPoint</span><span class="p">,</span> <span class="n">Qt</span><span class="p">,</span> <span class="n">QTimer</span><span class="p">,</span> <span class="n">QObject</span><span class="p">,</span> <span class="n">QThread</span>
<span class="kn">from</span> <span class="nn">PyQt4</span> <span class="k">import</span> <span class="n">QtGui</span>
<span class="kn">from</span> <span class="nn">PyQt4.QtWebKit</span> <span class="k">import</span> <span class="n">QWebPage</span>
<span class="kn">from</span> <span class="nn">PyQt4.QtTest</span> <span class="k">import</span> <span class="n">QTest</span>

</pre></div>
</div>
</div>
<div class="section" id="local">
<h3>Local<a class="headerlink" href="#local" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python3"><div class="highlight"><pre>
<span class="kn">from</span> <span class="nn">enki.core.core</span> <span class="k">import</span> <span class="n">core</span>
<span class="kn">from</span> <span class="nn">enki.lib.future</span> <span class="k">import</span> <span class="n">AsyncController</span>

</pre></div>
</div>
<p>If TRE isn&#8217;t installed, this import will fail. In this case, disable the sync
feature.</p>
<div class="highlight-python3"><div class="highlight"><pre>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">approx_match</span> <span class="k">import</span> <span class="n">findApproxTextInTarget</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">findApproxTextInTarget</span> <span class="o">=</span> <span class="k">None</span>

</pre></div>
</div>
</div>
</div>
<div class="section" id="previewsync">
<h2>PreviewSync<a class="headerlink" href="#previewsync" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python3"><div class="highlight"><pre>
<span class="k">class</span> <span class="nc">PreviewSync</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class synchronizes the contents of the web and text views and aligns</span>
<span class="sd">       them vertically.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">textToPreviewSynced</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Setup / cleanup</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
    <span class="c">##===============</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>The web view involved in synchronization</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
      <span class="n">webView</span><span class="p">):</span>

        <span class="n">QObject</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Only set up sync if TRE is installed.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">findApproxTextInTarget</span><span class="p">:</span>
            <span class="k">return</span>

</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Gather into one variable all the JavaScript needed for PreviewSync.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="bp">self</span><span class="o">.</span><span class="n">_jsPreviewSync</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jsOnClick</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jsWebCursorCoords</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">webView</span> <span class="o">=</span> <span class="n">webView</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initPreviewToTextSync</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initTextToPreviewSync</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_onJavaScriptCleared</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This is called before starting a new load of a web page, to inject the</span>
<span class="sd">           JavaScript needed for PreviewSync.&quot;&quot;&quot;</span>
        <span class="n">mf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">webView</span><span class="o">.</span><span class="n">page</span><span class="p">()</span><span class="o">.</span><span class="n">mainFrame</span><span class="p">()</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Use <a class="reference external" href="http://qt-project.org/doc/qt-5.0/qtwebkit/qwebframe.html#addToJavaScriptWindowObject">addToJavaScriptWindowObject</a>
to make this PreviewDock object known to JavaScript, so that
JavaScript can emit the <tt class="docutils literal"><span class="pre">jsClick</span></tt> signal defined by PreviewDock.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="n">mf</span><span class="o">.</span><span class="n">addToJavaScriptWindowObject</span><span class="p">(</span><span class="s">&quot;PyPreviewDock&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Use <a class="reference external" href="http://qt-project.org/doc/qt-5.0/qtwebkit/qwebframe.html#evaluateJavaScript">evaluateJavaScript</a>
to insert JavaScript needed by PreviewSync.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="n">res</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">evaluateJavaScript</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jsPreviewSync</span><span class="p">)</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Make sure no errors were returned; the result should be empty.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">del_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Uninstall the text-to-web sync only if it was installed in the first
place (it depends on TRE).</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="k">if</span> <span class="n">findApproxTextInTarget</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cursorMovementTimer</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="n">core</span><span class="o">.</span><span class="n">workspace</span><span class="p">()</span><span class="o">.</span><span class="n">cursorPositionChanged</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_onCursorPositionChanged</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ac</span><span class="o">.</span><span class="n">del_</span><span class="p">()</span>

</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Vertical synchronization</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
    <span class="c">##========================</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><p>These routines perform vertical synchronization.</p>
<p>This function returns a delta vertical scroll amount, in pixels, in order to
align the top (y) coordinate of the cursor in the target widget with the cursor
in the source widget. If the the two widgets don&#8217;t intersect vertically,
then the target cursor is scrolled to be as close to the source
widget as possible: if the source widget is above the target, the target
widget will scroll to place the cursor at the top of the widget; if the
source widget is below the target, the target widget will scroll to place
the cursor at the bottom of the widget.</p>
<p>Ideally, this would instead operate on the baseline of the text, rather
than the top (or bottom), but getting this is much harder.</p>
<p>TODO: diagram.</p>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
    <span class="k">def</span> <span class="nf">_alignScrollAmount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>The top (y) coordinate of the source widget in a global coordinate frame,
such as screen coordinates. In pixels.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
      <span class="n">sourceGlobalTop</span><span class="p">,</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>The top coordinate of the cursor in the source widget, measured from the
top of the widget, NOT the top of the viewport. In pixels.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
      <span class="n">sourceCursorTop</span><span class="p">,</span>

</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>The top (y) coordinate of the target widget in a global coordinate frame,
such as screen coordinates. In pixels.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
      <span class="n">targetGlobalTop</span><span class="p">,</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>The top coordinate of the cursor in the target widget, measured from the
top of the widget, NOT the top of the viewport. In pixels.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
      <span class="n">targetCursorTop</span><span class="p">,</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>The height of the target widget. In pixels.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
      <span class="n">targetHeight</span><span class="p">,</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>The height of the cursor in the target widget. In pixels.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
      <span class="n">targetCursorHeight</span><span class="p">):</span>

</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Compute the raw delta between the source and target widgets.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="n">dTop</span> <span class="o">=</span> <span class="p">(</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Global coords of the source cursor top.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
          <span class="p">(</span><span class="n">sourceGlobalTop</span> <span class="o">+</span> <span class="n">sourceCursorTop</span><span class="p">)</span> <span class="o">-</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Global coords of the target cursor top. The difference
gives the number of pixels separating them.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
          <span class="p">(</span><span class="n">targetGlobalTop</span> <span class="o">+</span> <span class="n">targetCursorTop</span><span class="p">)</span> <span class="p">);</span>

</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Clip the resulting delta so that the target cursor remains visible.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="n">dTop</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="o">-</span><span class="n">targetCursorTop</span><span class="p">,</span> <span class="n">dTop</span><span class="p">),</span>
          <span class="n">targetHeight</span> <span class="o">-</span> <span class="n">targetCursorHeight</span> <span class="o">-</span> <span class="n">targetCursorTop</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dTop</span>

</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>This string contains JavaScript code to determine the coordinates and height of the
anchor of the selection in the web view.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
    <span class="n">_jsWebCursorCoords</span> <span class="o">=</span> <span class="p">(</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><p>This function returns the [top, left] position in pixels of <tt class="docutils literal"><span class="pre">obj</span></tt>
relative to the screen, not to the viewport. This introduces one
potential problem: if obj is not visible when this is called, it
returns coordinates outside the screen (such that top or left is
negative or greater than the screen&#8217;s height or width.</p>
<dl class="docutils">
<dt>It was slightly modified from <a class="reference external" href="http://www.quirksmode.org/js/findpos.html">http://www.quirksmode.org/js/findpos.html</a>,</dt>
<dd>which reproduces jQuery&#8217;s offset method (<a class="reference external" href="https://api.jquery.com/offset/">https://api.jquery.com/offset/</a>).</dd>
</dl>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="s">&#39;function findPos(obj) {&#39;</span>
            <span class="s">&#39;var curLeft = 0;&#39;</span>
            <span class="s">&#39;var curTop = 0;&#39;</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>element.offsetLeft and element.offsetTop measure relative to
the object&#8217;s parent. Walk the tree of parents, summing each
offset to determine the offset from the origin of the web page.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
            <span class="s">&#39;do {&#39;</span>
                <span class="s">&#39;curLeft += obj.offsetLeft;&#39;</span>
                <span class="s">&#39;curTop += obj.offsetTop;&#39;</span>
            <span class="s">&#39;} while (obj = obj.offsetParent);&#39;</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>See <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/API/element.getBoundingClientRect">element.getBoundingClientRect</a>
for converting viewport coords to screen coords.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
            <span class="s">&#39;return [curLeft - window.scrollX, curTop - window.scrollY];&#39;</span>
        <span class="s">&#39;}&#39;</span> <span class="o">+</span>

</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><p>This function returns [top, left, width], of the current
selection, where:</p>
<blockquote>
<div><dl class="docutils">
<dt>top, left - coordinates of the anchor of the</dt>
<dd>selection relative to the screen, in pixels.</dd>
</dl>
<p>height - height at the beginning of the selection, in pixels.</p>
</div></blockquote>
<p>Adapted from <a class="reference external" href="http://stackoverflow.com/questions/2031518/javascript-selection-range-coordinates">http://stackoverflow.com/questions/2031518/javascript-selection-range-coordinates</a>.
Changes:</p>
<ul class="simple">
<li>jQuery usage eliminated for all but debug prints.</li>
<li>The original code used <tt class="docutils literal"><span class="pre">range.endOffset</span></tt> instead of
<tt class="docutils literal"><span class="pre">selection.focusOffset</span></tt>. This caused occasional errors when
dragging selections.</li>
</ul>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="s">&#39;function selectionAnchorCoords() {&#39;</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Using <tt class="docutils literal"><span class="pre">window.getSelection()</span></tt>
Make sure a <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/API/Selection">selection</a> exists.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
            <span class="s">&#39;var selection = window.getSelection();&#39;</span>
            <span class="s">&#39;if (selection.rangeCount == 0) return 0;&#39;</span>

</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>The selection can contain not just a point (from a
single mouse click) but a range (from a mouse drag or
shift+arrow keys).
We&#8217;re looking for the coordinates of the focus node
(the place where the mouse ends up after making the selection).
However, the range returned by <tt class="docutils literal"><span class="pre">selection.getRangeAt(0)</span></tt>
begins earlier in the document and ends later, regardless
how the mouse was dragged. So, create a new range containing
just the point at the focus node, so we actually get
a range pointing to where the mouse is.
Ref: <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/API/Selection.focusNode">focus</a> of the selection.
<a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/API/range">Range</a></div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
            <span class="s">&#39;rangeAtFocus = document.createRange();&#39;</span>
            <span class="s">&#39;rangeAtFocus.setStart(selection.focusNode, selection.focusOffset);&#39;</span>

</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Insert a measurable element (a span) at the selection&#8217;s
focus.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
            <span class="s">&#39;var span = document.createElement(&quot;span&quot;);&#39;</span>
            <span class="s">&#39;rangeAtFocus.insertNode(span);&#39;</span>

</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Measure coordinates at this span, then remove it. Note:
span.remove() isn&#8217;t supported in the PyQt 4 I&#8217;m running, hence
the longer syntax below.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
            <span class="s">&#39;ret = findPos(span);&#39;</span>
            <span class="s">&#39;height = span.offsetHeight;&#39;</span>
            <span class="s">&#39;span.parentNode.removeChild(span);&#39;</span>

            <span class="c">## Return      top,   left, height.</span>
            <span class="s">&#39;return    [ret[0], ret[1], height];&#39;</span>
        <span class="s">&#39;}&#39;</span><span class="p">)</span>

</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><p>Run JavaScript to determine the coordinates and height of the
anchor of the selection in the web view.</p>
<p>Return values:</p>
<p>None if the selection is empty, or (top, left) where:</p>
<blockquote>
<div><p>top - Top of the selection, measured from the web page&#8217;s origin. In pixels.</p>
<p>left - Left of the selection, measured from the web page&#8217;s origin. In pixels.</p>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
    <span class="k">def</span> <span class="nf">_webCursorCoords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">webView</span><span class="o">.</span><span class="n">page</span><span class="p">()</span><span class="o">.</span><span class="n">mainFrame</span><span class="p">()</span><span class="o">.</span> \
          <span class="n">evaluateJavaScript</span><span class="p">(</span><span class="s">&#39;selectionAnchorCoords();&#39;</span><span class="p">)</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>See if a 3-element tuple is returned. Null is returned if the
selection is empty.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">None</span>
        <span class="n">left</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">res</span>
        <span class="k">return</span> <span class="n">top</span><span class="p">,</span> <span class="n">height</span>

</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Scroll the web view to align its cursor with the qutepart cursor or vice
versa.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
    <span class="k">def</span> <span class="nf">_scrollSync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>True to scroll the web view so that its cursor aligns vertically with
the y coordinate of the text view. False to do the opposite: scroll the
text view to the y coordinate of the web view&#8217;s cursor.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
      <span class="n">doTextToWebSync</span><span class="p">):</span>

</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Per the <a class="reference external" href="http://qt-project.org/doc/qt-4.8/application-windows.html#window-geometry">window geometry</a>,
<a class="reference external" href="http://qt-project.org/doc/qt-4.8/qwidget.html#geometry-prop">geometry()</a>
is relative to the parent frame. Then, use <a class="reference external" href="http://qt-project.org/doc/qt-4.8/qwidget.html#mapToGlobal">mapToGlobal</a> to
put this in global coordinates. This works for <a class="reference external" href="http://qt-project.org/doc/qt-5.0/qtwebkit/qwebview.html">QWebView</a>, since it
inherits from QWidget.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="n">wv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">webView</span>
        <span class="n">qp</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">workspace</span><span class="p">()</span><span class="o">.</span><span class="n">currentDocument</span><span class="p">()</span><span class="o">.</span><span class="n">qutepart</span>
        <span class="n">qpGlobalTop</span> <span class="o">=</span> <span class="n">qp</span><span class="o">.</span><span class="n">mapToGlobal</span><span class="p">(</span><span class="n">qp</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span><span class="o">.</span><span class="n">topLeft</span><span class="p">())</span><span class="o">.</span><span class="n">y</span><span class="p">()</span>
        <span class="n">wvGlobalTop</span> <span class="o">=</span> <span class="n">wv</span><span class="o">.</span><span class="n">mapToGlobal</span><span class="p">(</span><span class="n">wv</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span><span class="o">.</span><span class="n">topLeft</span><span class="p">())</span><span class="o">.</span><span class="n">y</span><span class="p">()</span> <span class="o">-</span> <span class="mi">10</span>

</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><a class="reference external" href="http://qt-project.org/doc/qt-4.8/qplaintextedit.html#cursorRect-2">qutepart.cursorRect()</a>
gives a value in viewport == widget coordinates. Use that directly.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="n">cr</span> <span class="o">=</span> <span class="n">qp</span><span class="o">.</span><span class="n">cursorRect</span><span class="p">()</span>
        <span class="n">qpCursorTop</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">top</span><span class="p">()</span>
        <span class="n">qpCursorHeight</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">height</span><span class="p">()</span>

</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Widget height includes the scrollbars. Subtract that off to get a
viewable height for qutepart.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="n">qpHeight</span> <span class="o">=</span> <span class="n">qp</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span><span class="o">.</span><span class="n">height</span><span class="p">()</span>
        <span class="n">hsb</span> <span class="o">=</span> <span class="n">qp</span><span class="o">.</span><span class="n">horizontalScrollBar</span><span class="p">()</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>The scrollbar height is a constant, even if it&#8217;s hidden. So, only
include it in calculations if it&#8217;s visible.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="k">if</span> <span class="n">hsb</span><span class="o">.</span><span class="n">isVisible</span><span class="p">():</span>
            <span class="n">qpHeight</span> <span class="o">-=</span> <span class="n">qp</span><span class="o">.</span><span class="n">horizontalScrollBar</span><span class="p">()</span><span class="o">.</span><span class="n">height</span><span class="p">()</span>
        <span class="n">mf</span> <span class="o">=</span> <span class="n">wv</span><span class="o">.</span><span class="n">page</span><span class="p">()</span><span class="o">.</span><span class="n">mainFrame</span><span class="p">()</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Since <a class="reference external" href="http://qt-project.org/doc/qt-5.0/qtwebkit/qwebframe.html#scrollBarGeometry">scrollBarGeometry</a>
returns an empty rect if the scroll bar doesn&#8217;t exist, just subtract
its height.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="n">wvHeight</span> <span class="o">=</span> <span class="n">wv</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span><span class="o">.</span><span class="n">height</span><span class="p">()</span> <span class="o">-</span> <span class="n">mf</span><span class="o">.</span><span class="n">scrollBarGeometry</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">)</span><span class="o">.</span><span class="n">height</span><span class="p">()</span>

</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Use JavaScript to determine web view cursor height top and height.
There&#8217;s no nice Qt way that I&#8217;m aware of, since Qt doesn&#8217;t know about
these details inside a web view. If JavaScript can&#8217;t determine this, then
silently abort the sync.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_webCursorCoords</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">wvCursorTop</span><span class="p">,</span> <span class="n">wvCursorHeight</span> <span class="o">=</span> <span class="n">ret</span>

        <span class="k">if</span> <span class="n">doTextToWebSync</span><span class="p">:</span>
            <span class="n">deltaY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alignScrollAmount</span><span class="p">(</span><span class="n">qpGlobalTop</span><span class="p">,</span> <span class="n">qpCursorTop</span><span class="p">,</span>
              <span class="n">wvGlobalTop</span><span class="p">,</span> <span class="n">wvCursorTop</span><span class="p">,</span> <span class="n">wvHeight</span><span class="p">,</span> <span class="n">wvCursorHeight</span><span class="p">)</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Uncomment for helpful debug info.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
            <span class="c">##print((&quot;qpGlobalTop = %d, qpCursorTop = %d, qpHeight = %d, deltaY = %d\n&quot; +</span>
            <span class="c">##  &quot;  wvGlobalTop = %d, wvCursorTop = %d, wvHeight = %d, wvCursorHeight = %d)&quot;) %</span>
            <span class="c">##  (qpGlobalTop, qpCursorTop, qpHeight, deltaY,</span>
            <span class="c">##  wvGlobalTop, wvCursorTop, wvHeight, wvCursorHeight))</span>

</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><p>Scroll based on this info using <a class="reference external" href="http://qt-project.org/doc/qt-5.0/qtwebkit/qwebframe.html#scrollPosition-prop">setScrollPosition</a>.</p>
<p>Note that scroll bars are backwards: to make the text go up, you must
move the bars down (a positive delta) and vice versa. Hence, the
subtration, rather than addition, below.</p>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
            <span class="n">mf</span><span class="o">.</span><span class="n">setScrollPosition</span><span class="p">(</span><span class="n">mf</span><span class="o">.</span><span class="n">scrollPosition</span><span class="p">()</span> <span class="o">-</span> <span class="n">QPoint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">deltaY</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">deltaY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alignScrollAmount</span><span class="p">(</span><span class="n">wvGlobalTop</span><span class="p">,</span> <span class="n">wvCursorTop</span><span class="p">,</span>
              <span class="n">qpGlobalTop</span><span class="p">,</span> <span class="n">qpCursorTop</span><span class="p">,</span> <span class="n">qpHeight</span><span class="p">,</span> <span class="n">qpCursorHeight</span><span class="p">)</span>
            <span class="n">vsb</span> <span class="o">=</span> <span class="n">qp</span><span class="o">.</span><span class="n">verticalScrollBar</span><span class="p">()</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>The units for the vertical scroll bar is pixels not lines. So, do
a kludgy conversion by assuming that all line heights are the
same.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
            <span class="n">vsb</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">vsb</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="o">-</span> <span class="nb">round</span><span class="p">(</span><span class="n">deltaY</span><span class="o">/</span><span class="n">qpCursorHeight</span><span class="p">))</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Synchronizing between the text pane and the preview pane</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
    <span class="c">##========================================================</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><p>A single click in the preview pane should move the text pane&#8217;s cursor to the
corresponding location. Likewise, movement of the text pane&#8217;s cursor should
select the corresponding text in the preview pane. To do so, an approximate
search for text surrounding the current cursor or click location perfomed on
text in the other pane provides the corresponding location in the other pane
to highlight.</p>
<p>Bugs / to-do items</p>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
    <span class="c">##------------------</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><ol class="arabic simple">
<li>I call <tt class="docutils literal"><span class="pre">toPlainText()</span></tt> several times. In the past, this was quite slow
in a <tt class="docutils literal"><span class="pre">QTextEdit</span></tt>. Check performance and possibly cache this value; it
should be easy to update by adding a few lines to _setHtml().</li>
</ol>
<p>Preview-to-text sync</p>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
    <span class="c">##--------------------</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><p>This functionaliy relies heavily on the Web to Qt bridge. Some helpful
references:</p>
<ul class="simple">
<li><a class="reference external" href="http://qt-project.org/doc/qt-4.8/qtwebkit-bridge.html">The QtWebKit Bridge</a>
gives a helpful overview.</li>
<li><a class="reference external" href="http://qt-project.org/doc/qt-5.0/qtwebkit/qwebview.html">QWebView</a> is the top-level widget used to embed a Web page in a Qt
application.</li>
</ul>
<p>For this sync, the first step is to find the single click&#8217;s location in a
plain text rendering of the preview&#8217;s web content. This is implemented in
JavaScript, which emits a Qt signal with the location on a click. A slot
connected to this signal then performs the approximate match and updates the
text pane&#8217;s cursor. To do this:</p>
<ol class="arabic simple">
<li><tt class="docutils literal"><span class="pre">jsClick</span></tt>, a PyQt signal with a single numeric argument (the index into
a string containing the plain text rendering of the web page) is defined.
This signal is <a class="reference internal" href="#onjavascriptcleared-connect"><em>connected</em></a> to the
<tt class="docutils literal"><span class="pre">onWebviewClick</span></tt> slot.</li>
<li>The <tt class="docutils literal"><span class="pre">onJavaScriptCleared</span></tt> method inserts the JavaScript to listen for a
click and then emit a signal giving the click&#8217;s location.</li>
<li>The <tt class="docutils literal"><span class="pre">onWebviewClick</span></tt> method then performs the approximate match and
updates the text pane&#8217;s cursor location.</li>
<li>When a new web page is loaded, all JavaScript is lost and must be reinserted.
The <tt class="docutils literal"><span class="pre">onJavaScriptCleared</span></tt> slot, connected to the
<tt class="docutils literal"><span class="pre">javaScriptWindowObjectCleared</span></tt> signal, does this.</li>
</ol>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>

</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><p>The job of this JavaScript handler is to
translate a mouse click into an index into the text rendering of the
webpage. To do this, we must:</p>
<ol class="arabic simple">
<li>Get the current selection made by the mouse click, which is typically
an empty range. (I assume a click and drag will produce a non-empty
range; however this code still works).</li>
<li>Extend a copy of this range so that it begins at the start of the
webpage and, of course, ends at the character nearest the mouse
click.</li>
<li>Get a string rendering of this range.</li>
<li>Emit a signal with the length of this string.</li>
</ol>
<p>Note: A JavaScript development environment with this code is available
at <a class="reference external" href="http://jsfiddle.net/hgDwx/110/">http://jsfiddle.net/hgDwx/110/</a>.</p>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
    <span class="n">_jsOnClick</span> <span class="o">=</span> <span class="p">(</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>The <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/API/Window.onclick">window.onclick</a>
event is &#8220;called when the user clicks the mouse button while the
cursor is in the window.&#8221; Although the docs claim that &#8220;this event
is fired for any mouse button pressed&#8221;, I found experimentally
that it on fires on a left-click release; middle and right clicks
had no effect.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="s">&#39;window.onclick = function () {&#39;</span>

</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><p>This performs step 1 above. In particular:</p>
<ul class="simple">
<li><a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/API/Window.getSelection">window.getSelection</a>
&#8220;returns a <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/API/Selection">Selection</a>
object representing the range of text selected by the
user.&#8221; Since this is only called after a click, I assume
the Selection object is non-null.</li>
<li>The Selection.<a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/API/Selection.getRangeAt">getRangeAt</a>
method &#8220;returns a range object representing one of the
ranges currently selected.&#8221; Per the Selection <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/API/Selection#Glossary">glossary</a>,
&#8220;A user will normally only select a single range at a
time...&#8221; The index for retrieving a single-selection range
is of course 0.</li>
<li>&#8220;The <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/API/range">Range</a>
interface represents a fragment of a document that can
contain nodes and parts of text nodes in a given document.&#8221;
We clone it to avoid modifying the user&#8217;s existing
selection using <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/API/Range.cloneRange">cloneRange</a>.</li>
</ul>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
            <span class="s">&#39;var r = window.getSelection().getRangeAt(0).cloneRange();&#39;</span>

</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>This performs step 2 above: the cloned range is now changed
to contain the web page from its beginning to the point where
the user clicked by calling <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/API/Range.setStartBefore">setStartBefore</a>
on <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/API/document.body">document.body</a>.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
            <span class="s">&#39;r.setStartBefore(document.body);&#39;</span>

</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><p>Step 3:</p>
<ul class="simple">
<li><a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/API/Range.cloneContents">cloneContents</a>
&#8220;Returns a <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/API/DocumentFragment">DocumentFragment</a>
copying the nodes of a Range.&#8221;</li>
<li>DocumentFragment&#8217;s parent <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/API/Node">Node</a>
provides a <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/API/Node.textContent">textContent</a>
property which gives &#8220;a DOMString representing the textual
content of an element and all its descendants.&#8221; This therefore
contains a text rendering of the webpage from the beginning of the
page to the point where the user clicked.</li>
</ul>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
             <span class="s">&#39;var rStr = r.cloneContents().textContent.toString();&#39;</span>

</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Step 4: the length of the string gives the index of the click
into a string containing a text rendering of the webpage.
Emit a signal with that information.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
            <span class="s">&#39;PyPreviewDock.jsClick(rStr.length);&#39;</span>
        <span class="s">&#39;};&#39;</span><span class="p">)</span>

</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>A signal emitted by clicks in the web view, per 1 above.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
    <span class="n">jsClick</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>The index of the clicked character in a text rendering
of the web page.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
      <span class="nb">int</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_initPreviewToTextSync</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the system per items 1, 2, and 4 above.&quot;&quot;&quot;</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Insert our on-click JavaScript.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="bp">self</span><span class="o">.</span><span class="n">_onJavaScriptCleared</span><span class="p">()</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><p id="onjavascriptcleared-connect">Connect the signal emitted by the JavaScript onclick handler to
<tt class="docutils literal"><span class="pre">onWebviewClick</span></tt>.</p>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="bp">self</span><span class="o">.</span><span class="n">jsClick</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_onWebviewClick</span><span class="p">)</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Qt emits the <a class="reference external" href="http://qt-project.org/doc/qt-5.0/qtwebkit/qwebframe.html#javaScriptWindowObjectCleared.">javaScriptWindowObjectCleared</a>
signal when a web page is loaded. When this happens, reinsert our
onclick JavaScript.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="bp">self</span><span class="o">.</span><span class="n">webView</span><span class="o">.</span><span class="n">page</span><span class="p">()</span><span class="o">.</span><span class="n">mainFrame</span><span class="p">()</span><span class="o">.</span> \
          <span class="n">javaScriptWindowObjectCleared</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_onJavaScriptCleared</span><span class="p">)</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Run the approximate match in a separate thread.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ac</span> <span class="o">=</span> <span class="n">AsyncController</span><span class="p">(</span><span class="s">&#39;QThread&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ac</span><span class="o">.</span><span class="n">_workerThread</span><span class="o">.</span><span class="n">setPriority</span><span class="p">(</span><span class="n">QThread</span><span class="o">.</span><span class="n">LowPriority</span><span class="p">)</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Create a dummy future object for use in canceling pending sync jobs
when a new sync needs to be run.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="bp">self</span><span class="o">.</span><span class="n">_future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ac</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="k">None</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="k">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_webTextContent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the ``textContent`` of the entire web page. This differs from</span>
<span class="sd">        ``mainFrame().toPlainText()``, which uses ``innerText`` and therefore</span>
<span class="sd">        produces a slightly differnt result. Since the JavaScript signal&#39;s index</span>
<span class="sd">        is computed based on textContent, that must be used for all web to text</span>
<span class="sd">        sync operations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">webView</span><span class="o">.</span><span class="n">page</span><span class="p">()</span><span class="o">.</span><span class="n">mainFrame</span><span class="p">()</span><span class="o">.</span>
          <span class="n">evaluateJavaScript</span><span class="p">(</span><span class="s">&#39;document.body.textContent.toString()&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_onWebviewClick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">webIndex</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Per item 3 above, this is called when the user clicks in the web view. It</span>
<span class="sd">        finds the matching location in the text pane then moves the text pane</span>
<span class="sd">        cursor.</span>

<span class="sd">        Params:</span>
<span class="sd">        webIndex - The index of the clicked character in a text rendering</span>
<span class="sd">            of the web page.</span>
<span class="sd">        &quot;&quot;&quot;</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Retrieve the web page text and the qutepart text.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="n">tc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_webTextContent</span><span class="p">()</span>
        <span class="n">qp</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">workspace</span><span class="p">()</span><span class="o">.</span><span class="n">currentDocument</span><span class="p">()</span><span class="o">.</span><span class="n">qutepart</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Perform an approximate match between the clicked webpage text and the
qutepart text.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="n">textIndex</span> <span class="o">=</span> <span class="n">findApproxTextInTarget</span><span class="p">(</span><span class="n">tc</span><span class="p">,</span> <span class="n">webIndex</span><span class="p">,</span> <span class="n">qp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Move the cursor to textIndex in qutepart, assuming corresponding text
was found.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="k">if</span> <span class="n">textIndex</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_moveTextPaneToIndex</span><span class="p">(</span><span class="n">textIndex</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_moveTextPaneToIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">textIndex</span><span class="p">,</span> <span class="n">noWebSync</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Given an index into the text pane, move the cursor to that index.</span>

<span class="sd">        Params:</span>
<span class="sd">        textIndex - The index into the text pane at which to place the cursor.</span>
<span class="sd">        noWebSync - True to prevent the web-to-text sync from running as a</span>
<span class="sd">            result of calling this routine.</span>
<span class="sd">        &quot;&quot;&quot;</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Move the cursor to textIndex.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="n">qp</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">workspace</span><span class="p">()</span><span class="o">.</span><span class="n">currentDocument</span><span class="p">()</span><span class="o">.</span><span class="n">qutepart</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">qp</span><span class="o">.</span><span class="n">textCursor</span><span class="p">()</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Tell the text to preview sync to ignore this cursor position change.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="n">cursor</span><span class="o">.</span><span class="n">setPosition</span><span class="p">(</span><span class="n">textIndex</span><span class="p">,</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QTextCursor</span><span class="o">.</span><span class="n">MoveAnchor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_previewToTextSyncRunning</span> <span class="o">=</span> <span class="n">noWebSync</span>
        <span class="n">qp</span><span class="o">.</span><span class="n">setTextCursor</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_previewToTextSyncRunning</span> <span class="o">=</span> <span class="k">False</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Scroll the document to make sure the cursor is visible.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="n">qp</span><span class="o">.</span><span class="n">ensureCursorVisible</span><span class="p">()</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Sync the cursors.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scrollSync</span><span class="p">(</span><span class="k">False</span><span class="p">)</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Focus on the editor so the cursor will be shown and ready for typing.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="n">core</span><span class="o">.</span><span class="n">workspace</span><span class="p">()</span><span class="o">.</span><span class="n">focusCurrentDocument</span><span class="p">()</span>

</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Text-to-preview sync</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
    <span class="c">##--------------------</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><p>The opposite direction is easier, since all the work can be done in Python.
When the cursor moves in the text pane, find its matching location in the
preview pane using an approximate match. Select several characters before and
after the matching point to make the location more visible, since the preview
pane lacks a cursor. Specifically:</p>
<ol class="arabic simple">
<li>initTextToPreviewSync sets up a timer and connects the _onCursorPositionChanged method.</li>
<li>_onCursorPositionChanged is called each time the cursor moves. It starts or
resets a short timer. The timer&#8217;s expiration calls syncTextToWeb.</li>
<li>syncTextToWeb performs the approximate match, then calls moveWebPaneToIndex
to sync the web pane with the text pane.</li>
<li>moveWebToPane uses QWebFrame.find to search for the text under the anchor
then select (or highlight) it.</li>
</ol>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>

    <span class="k">def</span> <span class="nf">_initTextToPreviewSync</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called when constructing the PreviewDoc. It performs item 1 above.&quot;&quot;&quot;</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Create a timer which will sync the preview with the text cursor a
short time after cursor movement stops.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cursorMovementTimer</span> <span class="o">=</span> <span class="n">QTimer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cursorMovementTimer</span><span class="o">.</span><span class="n">setInterval</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cursorMovementTimer</span><span class="o">.</span><span class="n">timeout</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">syncTextToPreview</span><span class="p">)</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Restart this timer every time the cursor moves.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="n">core</span><span class="o">.</span><span class="n">workspace</span><span class="p">()</span><span class="o">.</span><span class="n">cursorPositionChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_onCursorPositionChanged</span><span class="p">)</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Set up a variable to tell us when the preview to text sync just fired,
disabling this sync. Otherwise, that sync would trigger this sync,
which is unnecessary.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="bp">self</span><span class="o">.</span><span class="n">_previewToTextSyncRunning</span> <span class="o">=</span> <span class="k">False</span>

    <span class="k">def</span> <span class="nf">_onCursorPositionChanged</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called when the cursor position in the text pane changes. It (re)schedules</span>
<span class="sd">        a text to web sync per item 2 above. Note that the signal connected to</span>
<span class="sd">        this slot must be updated when the current document changes, since we only</span>
<span class="sd">        want cursor movement notification from the active text document. This is</span>
<span class="sd">        handled in _onDocumentChanged.</span>
<span class="sd">        &quot;&quot;&quot;</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Ignore this callback if a preview to text sync caused it or if the
preview dock is closed.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_previewToTextSyncRunning</span> <span class="ow">and</span>
          <span class="n">core</span><span class="o">.</span><span class="n">config</span><span class="p">()[</span><span class="s">&#39;Preview&#39;</span><span class="p">][</span><span class="s">&#39;Enabled&#39;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cursorMovementTimer</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cursorMovementTimer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">syncTextToPreview</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;When the timer above expires, this is called to sync text to preview</span>
<span class="sd">        per item 3 above. It can also be called when a sync is needed (when</span>
<span class="sd">        switching windows, for example).</span>
<span class="sd">        &quot;&quot;&quot;</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Only run this if we TRE is installed.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">findApproxTextInTarget</span><span class="p">:</span>
            <span class="k">return</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Stop the timer; the next cursor movement will restart it.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cursorMovementTimer</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Perform an approximate match in a separate thread, then update
the cursor based on the match results.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="n">mf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">webView</span><span class="o">.</span><span class="n">page</span><span class="p">()</span><span class="o">.</span><span class="n">mainFrame</span><span class="p">()</span>
        <span class="n">qp</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">workspace</span><span class="p">()</span><span class="o">.</span><span class="n">currentDocument</span><span class="p">()</span><span class="o">.</span><span class="n">qutepart</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">toPlainText</span><span class="p">()</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Before starting a new sync job, cancel pending ones.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="bp">self</span><span class="o">.</span><span class="n">_future</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ac</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_movePreviewPaneToIndex</span><span class="p">,</span> <span class="n">findApproxTextInTarget</span><span class="p">,</span>
                       <span class="n">qp</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">qp</span><span class="o">.</span><span class="n">textCursor</span><span class="p">()</span><span class="o">.</span><span class="n">position</span><span class="p">(),</span> <span class="n">txt</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_movePreviewPaneToIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">future</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Highlights webIndex in the preview pane, per item 4 above.</span>

<span class="sd">        Params:</span>
<span class="sd">        webIndex - The index to move the cursor / highlight to in the preview</span>
<span class="sd">          pane.</span>
<span class="sd">        txt - The text of the webpage, returned by mainFrame.toPlainText().</span>
<span class="sd">        &quot;&quot;&quot;</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Retrieve the return value from findApproxTextInTarget.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="n">webIndex</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Only move the cursor to webIndex in the preview pane if
corresponding text was found.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="k">if</span> <span class="n">webIndex</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Implementation: there&#8217;s no direct way I know of to move the cursor in
a web page. However, the find operation is fairly common. So, simply
search from the beginning of the page for a substring of the web
page&#8217;s text rendering from the beginning to webIndex. Then press home
followed by shift+end to select the line the cursor is on. (This
relies on the page being editable, which is set in
_initTextToPreviewSync).</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="n">pg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">webView</span><span class="o">.</span><span class="n">page</span><span class="p">()</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Start the search location at the beginning of the document by clearing
the previous selection using <a class="reference external" href="http://qt-project.org/doc/qt-4.8/qwebpage.html#findText">findText</a> with an
empty search string.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="n">pg</span><span class="o">.</span><span class="n">findText</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Find the index with <a class="reference external" href="http://qt-project.org/doc/qt-4.8/qwebpage.html#findText">findText</a>.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">mainFrame</span><span class="p">()</span><span class="o">.</span><span class="n">toPlainText</span><span class="p">()</span>
        <span class="n">ft</span> <span class="o">=</span> <span class="n">txt</span><span class="p">[:</span><span class="n">webIndex</span><span class="p">]</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">findText</span><span class="p">(</span><span class="n">ft</span><span class="p">,</span> <span class="n">QWebPage</span><span class="o">.</span><span class="n">FindCaseSensitively</span><span class="p">)</span>

</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Before highlighting a line, make sure the text was found. If the
search string was empty, it still counts (found is false, but
highlighting will still work).</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
        <span class="k">if</span> <span class="n">found</span> <span class="ow">or</span> <span class="p">(</span><span class="n">webIndex</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><p>Select the entire line containing the anchor: make the page
temporarily editable, then press home then shift+end using <a class="reference external" href="http://qt-project.org/doc/qt-4.8/qtest.html#keyClick">keyClick</a>. Other ideas
on how to do this:</p>
<ol class="arabic simple">
<li>The same idea, but done in JavaScript. Playing with this produced
a set of failures &#8211; in a <tt class="docutils literal"><span class="pre">conteneditable</span></tt> area, I couldn&#8217;t
perform any edits by sending keypresses. The best reference I
found for injecting keypresses was <a class="reference external" href="http://stackoverflow.com/questions/10455626/keydown-simulation-in-chrome-fires-normally-but-not-the-correct-key/12522769#12522769">this jsbin demo</a>.</li>
</ol>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
            <span class="n">ice</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">isContentEditable</span><span class="p">()</span>
            <span class="n">pg</span><span class="o">.</span><span class="n">setContentEditable</span><span class="p">(</span><span class="k">True</span><span class="p">)</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>If the find text ends with a newline, findText doesn&#8217;t include
the newline. Manaully move one char forward in this case to get it.
This is tested in test_preview.py:test_sync10, test_sync11.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
            <span class="k">if</span> <span class="n">ft</span> <span class="ow">and</span> <span class="n">ft</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">:</span>
                <span class="n">QTest</span><span class="o">.</span><span class="n">keyClick</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">webView</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">Key_Right</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">ShiftModifier</span><span class="p">)</span>
            <span class="n">QTest</span><span class="o">.</span><span class="n">keyClick</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">webView</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">Key_Home</span><span class="p">)</span>
            <span class="n">QTest</span><span class="o">.</span><span class="n">keyClick</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">webView</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">Key_End</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">ShiftModifier</span><span class="p">)</span>
            <span class="n">pg</span><span class="o">.</span><span class="n">setContentEditable</span><span class="p">(</span><span class="n">ice</span><span class="p">)</span>

</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Sync the cursors.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-python3"><div class="highlight"><pre>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scrollSync</span><span class="p">(</span><span class="k">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">textToPreviewSynced</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li><a href="index.html">Project Name version 0.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Author.
      Last updated on Dec, 12, 2014.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>